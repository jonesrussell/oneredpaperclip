name: deploy

on:
  workflow_run:
    workflows: ['tests']
    types: [completed]
    branches: [main]
  workflow_dispatch:

concurrency:
  group: deploy
  cancel-in-progress: false

jobs:
  deploy:
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}
          fetch-depth: 1

      - name: Download Deployer
        run: |
          curl -LO https://deployer.org/deployer.phar
          chmod +x deployer.phar
          sudo mv deployer.phar /usr/local/bin/dep

      - name: Setup SSH
        run: |
          eval "$(ssh-agent -s)"
          echo "SSH_AUTH_SOCK=$SSH_AUTH_SOCK" >> $GITHUB_ENV
          echo "SSH_AGENT_PID=$SSH_AGENT_PID" >> $GITHUB_ENV
          if [ -n "$SSH_PRIVATE_KEY_BASE64" ]; then
            echo "Using SSH_PRIVATE_KEY_BASE64"
            echo "$SSH_PRIVATE_KEY_BASE64" | base64 -d | ssh-add -
          else
            echo "Using SSH_PRIVATE_KEY"
            echo "$SSH_PRIVATE_KEY" | ssh-add -
          fi
          echo "Loaded keys:"
          ssh-add -l
          if [ $(ssh-add -l | wc -l) -eq 0 ]; then
            echo "::error::No SSH key loaded. Add SSH_PRIVATE_KEY or SSH_PRIVATE_KEY_BASE64 to this repo's Actions secrets (Settings → Secrets and variables → Actions)."
            exit 1
          fi
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SSH_PRIVATE_KEY_BASE64: ${{ secrets.SSH_PRIVATE_KEY_BASE64 }}

      - name: Add Host Key
        run: |
          mkdir -p "$HOME/.ssh"
          ssh-keyscan -T 10 -H coforge.xyz >> "$HOME/.ssh/known_hosts" 2>/dev/null || true
          {
            echo "Host coforge.xyz"
            echo "  User deployer"
            echo "  StrictHostKeyChecking no"
          } >> "$HOME/.ssh/config"
          chmod 600 "$HOME/.ssh/config"

      - name: Test SSH connection
        run: |
          ssh -v -o BatchMode=yes deployer@coforge.xyz "echo SSH_OK" || true

      - name: Deploy
        env:
          DEPLOY_ENV: production
        run: |
          set -e
          dep deploy coforge.xyz -v
